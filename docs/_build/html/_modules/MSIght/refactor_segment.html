<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MSIght.refactor_segment &#8212; MSIght December 2024 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=8a903c05"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for MSIght.refactor_segment</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Fri Nov 15 16:33:13 2024</span>

<span class="sd">@author: lafields2</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">pyimzml.ImzMLParser</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">gaussian_filter1d</span><span class="p">,</span><span class="n">white_tophat</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">mpatches</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">filters</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">median_filter</span><span class="p">,</span> <span class="n">binary_erosion</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">silhouette_score</span>
<span class="kn">from</span> <span class="nn">MSIght.refactor_common_functions</span> <span class="kn">import</span> <span class="n">load_and_preprocess_imzml</span><span class="p">,</span><span class="n">create_intensity_matrix</span><span class="p">,</span><span class="n">apply_dimensionality_reduction</span>

<div class="viewcode-block" id="cluster_msi">
<a class="viewcode-back" href="../../api_reference.html#MSIght.refactor_segment.cluster_msi">[docs]</a>
<span class="k">def</span> <span class="nf">cluster_msi</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">output_directory</span><span class="p">,</span><span class="n">sample_name</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">structuring_element_size</span><span class="p">,</span><span class="n">pca_components</span><span class="p">,</span>
           <span class="n">tsne_components</span><span class="p">,</span><span class="n">tsne_perplexity</span><span class="p">,</span><span class="n">tsne_interations</span><span class="p">,</span><span class="n">tsne_learning_rate</span><span class="p">,</span><span class="n">k_means_cluster_number</span><span class="p">):</span>
    <span class="n">coordinates</span><span class="p">,</span> <span class="n">mz_values</span><span class="p">,</span> <span class="n">intensities</span> <span class="o">=</span> <span class="n">load_and_preprocess_imzml</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">structuring_element_size</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="p">],</span>
        <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="p">],</span>
        <span class="s1">&#39;mz_values&#39;</span><span class="p">:</span> <span class="n">mz_values</span><span class="p">,</span>
        <span class="s1">&#39;intensities&#39;</span><span class="p">:</span> <span class="n">intensities</span><span class="p">})</span>
    <span class="n">intensity_matrix</span><span class="p">,</span> <span class="n">all_mz_values</span> <span class="o">=</span> <span class="n">create_intensity_matrix</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">mz_values</span><span class="p">,</span> <span class="n">intensities</span><span class="p">)</span>
    <span class="n">intensity_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">intensity_matrix</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">all_mz_values</span><span class="p">)</span> <span class="c1"># Convert the intensity matrix to a DataFrame</span>
    <span class="n">df_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]],</span> <span class="n">intensity_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Combine coordinates with the intensity data</span>
    <span class="n">pca_result</span><span class="p">,</span> <span class="n">tsne_result</span> <span class="o">=</span> <span class="n">apply_dimensionality_reduction</span><span class="p">(</span><span class="n">intensity_matrix</span><span class="p">,</span> <span class="n">pca_components</span><span class="p">,</span> <span class="n">tsne_components</span><span class="p">,</span> <span class="n">tsne_perplexity</span><span class="p">,</span><span class="n">tsne_interations</span><span class="p">,</span><span class="n">tsne_learning_rate</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tsne-one&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsne_result</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># Add t-SNE results back to DataFrame</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tsne-two&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsne_result</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="c1"># Add t-SNE results back to DataFrame</span>
    <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">k_means_cluster_number</span><span class="p">)</span> <span class="c1"># Cluster using K-means</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">pca_result</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="c1"># Visualize the t-SNE result</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;tsne-one&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;tsne-two&quot;</span><span class="p">,</span>
        <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span>
        <span class="n">palette</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">),</span>
        <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
        <span class="n">legend</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;t-SNE of Mass Spectrometry Image with K-means Clustering&#39;</span><span class="p">)</span>
    <span class="n">fig_outpath</span> <span class="o">=</span> <span class="n">output_directory</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">sample_name</span> <span class="o">+</span> <span class="s1">&#39;_tSNE_cluster.png&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_outpath</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="c1"># Define a fixed color map</span>
    <span class="n">cluster_colors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span>  <span class="c1"># Blue</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;#ff7f0e&#39;</span><span class="p">,</span>  <span class="c1"># Orange</span>
        <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;#2ca02c&#39;</span><span class="p">,</span>  <span class="c1"># Green</span>
        <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;#d62728&#39;</span><span class="p">,</span>  <span class="c1"># Red</span>
        <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;#9467bd&#39;</span><span class="p">,</span>  <span class="c1"># Purple</span>
        <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;#EC2E8C&#39;</span><span class="p">,</span>  <span class="c1"># Pink</span>
        <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;#f032e6&#39;</span><span class="p">,</span>  <span class="c1"># Yellow</span>
        <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;#9CE060&#39;</span><span class="p">,</span>  <span class="c1"># Light green</span>
    <span class="p">}</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">([</span><span class="n">cluster_colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_means_cluster_number</span><span class="p">)])</span> <span class="c1"># Create a colormap for the clusters</span>
    <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
    <span class="n">cluster_image_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span> <span class="c1"># Create the full cluster image</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
        <span class="n">cluster_image_full</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cluster_image_full</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cluster Image of Tissue Spectra&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> <span class="c1"># Display the full cluster image</span>
    <span class="n">unique_clusters_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">])</span>
    <span class="n">legend_handles_full</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">cluster_colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Cluster </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unique_clusters_full</span><span class="p">]</span> <span class="c1"># Create custom legend handles for both images</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">im_full</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cluster_image_full</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Full Clustered Mass Spectrometry Image&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_handles_full</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
    <span class="n">fig_outpath</span> <span class="o">=</span> <span class="n">output_directory</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">sample_name</span> <span class="o">+</span> <span class="s1">&#39;_MSI_tSNE_cluster_overlay.png&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_outpath</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="n">fig_outpath</span> <span class="o">=</span> <span class="n">output_directory</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">sample_name</span> <span class="o">+</span> <span class="s1">&#39;_MSI_tSNE_cluster_overlay.png&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_outpath</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span><span class="n">cluster_colors</span><span class="p">,</span><span class="n">cluster_image_full</span><span class="p">,</span><span class="n">cmap</span><span class="p">,</span><span class="n">legend_handles_full</span><span class="p">,</span><span class="n">tsne_result</span></div>


<div class="viewcode-block" id="cluster_removal">
<a class="viewcode-back" href="../../api_reference.html#MSIght.refactor_segment.cluster_removal">[docs]</a>
<span class="k">def</span> <span class="nf">cluster_removal</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">cluster_colors</span><span class="p">,</span><span class="n">cluster_image_full</span><span class="p">,</span><span class="n">cmap</span><span class="p">,</span><span class="n">legend_handles_full</span><span class="p">,</span><span class="n">clusters_to_remove</span><span class="p">,</span><span class="n">output_directory</span><span class="p">,</span><span class="n">sample_name</span><span class="p">):</span>
    <span class="n">filtered_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">clusters_to_remove</span><span class="p">)]</span> <span class="c1"># Filter out the rows with clusters to remove</span>
    <span class="n">cluster_image_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Initialize with -1 to handle missing data</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
        <span class="n">cluster_image_filtered</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span>
    <span class="n">unique_clusters_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">filtered_df</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">])</span> <span class="c1"># Create the cluster image without specific clusters</span>
    <span class="n">legend_handles_filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">cluster_colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Cluster </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unique_clusters_filtered</span><span class="p">]</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">im_full</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cluster_image_full</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Full Clustered Mass Spectrometry Image&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_handles_full</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
    <span class="n">cmap_filtered</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">([</span><span class="n">cluster_colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unique_clusters_filtered</span><span class="p">])</span> <span class="c1"># Filtered cluster image</span>
    <span class="n">im_filtered</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cluster_image_filtered</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_filtered</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Clustered Mass Spectrometry Image without Specific Clusters&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_handles_filtered</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
    <span class="n">fig_outpath</span> <span class="o">=</span> <span class="n">output_directory</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">sample_name</span> <span class="o">+</span> <span class="s1">&#39;_MSI_tSNE_cluster_overlay_w_clusters_remove.png&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_outpath</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filtered_df</span></div>


<div class="viewcode-block" id="make_composite_image">
<a class="viewcode-back" href="../../api_reference.html#MSIght.refactor_segment.make_composite_image">[docs]</a>
<span class="k">def</span> <span class="nf">make_composite_image</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">threshold</span><span class="p">,</span><span class="n">output_directory</span><span class="p">,</span><span class="n">sample_name</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_imzml</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">pyimzml</span><span class="o">.</span><span class="n">ImzMLParser</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">coordinates</span><span class="p">):</span>
            <span class="n">mzs</span><span class="p">,</span> <span class="n">intens</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getspectrum</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">mzs</span><span class="p">,</span> <span class="n">intens</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;mz_values&#39;</span><span class="p">,</span> <span class="s1">&#39;intensities&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">def</span> <span class="nf">filter_intensities_above_threshold</span><span class="p">(</span><span class="n">mz_values</span><span class="p">,</span> <span class="n">intensities</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span> <span class="c1"># Function to filter intensities above a given threshold</span>
        <span class="n">filtered_intensities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">intens</span> <span class="ow">in</span> <span class="n">intensities</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">intens</span> <span class="o">&gt;</span> <span class="n">threshold</span>
            <span class="n">filtered_intensities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">intens</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">filtered_intensities</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">create_composite_image_for_intensity_threshold</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span> <span class="c1"># Function to create the composite image for intensities above a threshold</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
        <span class="n">composite_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
        <span class="n">mz_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;mz_values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">intensities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;intensities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">filtered_intensities</span> <span class="o">=</span> <span class="n">filter_intensities_above_threshold</span><span class="p">(</span><span class="n">mz_values</span><span class="p">,</span> <span class="n">intensities</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">intens</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">filtered_intensities</span><span class="p">):</span>
            <span class="n">composite_image</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">intens</span>
        <span class="k">return</span> <span class="n">composite_image</span>
    <span class="n">composite_image</span> <span class="o">=</span> <span class="n">create_composite_image_for_intensity_threshold</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span> <span class="c1"># Create the composite image for intensities above the threshold</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="c1"># Plot the composite image with raw, unnormalized values using matplotlib</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">composite_image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Composite Image for Intensities Above Threshold=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">fig_outpath</span> <span class="o">=</span> <span class="n">output_directory</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">sample_name</span> <span class="o">+</span> <span class="s1">&#39;_MSI_composite_image_all_mz.png&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_outpath</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">composite_image</span></div>


<div class="viewcode-block" id="composite_wo_selected_clusters">
<a class="viewcode-back" href="../../api_reference.html#MSIght.refactor_segment.composite_wo_selected_clusters">[docs]</a>
<span class="k">def</span> <span class="nf">composite_wo_selected_clusters</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">clusters_to_remove</span><span class="p">,</span><span class="n">composite_image</span><span class="p">,</span><span class="n">output_directory</span><span class="p">,</span><span class="n">sample_name</span><span class="p">):</span>
    <span class="n">coordinates_to_remove</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">clusters_to_remove</span><span class="p">)][[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">list_coord</span> <span class="o">=</span> <span class="n">coordinates_to_remove</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">filtered_image</span> <span class="o">=</span> <span class="n">composite_image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">list_coord</span><span class="p">:</span> <span class="c1"># Set the specified coordinates to zero</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">coord</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">filtered_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">filtered_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">filtered_image</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">filtered_image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
    <span class="n">fig_outpath</span> <span class="o">=</span> <span class="n">output_directory</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">sample_name</span> <span class="o">+</span> <span class="s1">&#39;_MSI_filtered_image_w_clusters_removed.png&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_outpath</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filtered_image</span></div>


<div class="viewcode-block" id="remove_residual_noise">
<a class="viewcode-back" href="../../api_reference.html#MSIght.refactor_segment.remove_residual_noise">[docs]</a>
<span class="k">def</span> <span class="nf">remove_residual_noise</span><span class="p">(</span><span class="n">filtered_image</span><span class="p">,</span><span class="n">median_filter_size</span><span class="p">,</span><span class="n">output_directory</span><span class="p">,</span><span class="n">sample_name</span><span class="p">):</span>
    <span class="n">tissue_image</span> <span class="o">=</span> <span class="n">filtered_image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">threshold_otsu</span><span class="p">(</span><span class="n">tissue_image</span><span class="p">)</span>
    <span class="n">tissue_mask</span> <span class="o">=</span> <span class="n">tissue_image</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="c1"># Create a binary mask of the tissue region</span>
    <span class="n">edge_mask</span> <span class="o">=</span> <span class="n">tissue_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">binary_erosion</span><span class="p">(</span><span class="n">tissue_mask</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># Erode the mask to create a mask for the edges</span>
    <span class="n">filtered_image</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">tissue_image</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">median_filter_size</span><span class="p">)</span> <span class="c1"># Apply the median filter to the entire image</span>
    <span class="n">final_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">edge_mask</span><span class="p">,</span> <span class="n">filtered_image</span><span class="p">,</span> <span class="n">tissue_image</span><span class="p">)</span> <span class="c1"># Combine the filtered edges with the original image</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="c1"># Plot the original, mask, and final images</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">tissue_image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Original Image&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">edge_mask</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Edge Mask&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">final_image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Final Image (Filtered Edges)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">fig_outpath</span> <span class="o">=</span> <span class="n">output_directory</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">sample_name</span> <span class="o">+</span> <span class="s1">&#39;_MSI_median_filtered_image.png&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_outpath</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final_image</span></div>


<div class="viewcode-block" id="cluster_msi_scored_w_csv">
<a class="viewcode-back" href="../../api_reference.html#MSIght.refactor_segment.cluster_msi_scored_w_csv">[docs]</a>
<span class="k">def</span> <span class="nf">cluster_msi_scored_w_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">output_directory</span><span class="p">,</span> <span class="n">sample_name</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">structuring_element_size</span><span class="p">,</span> <span class="n">pca_components</span><span class="p">,</span>
                <span class="n">tsne_components</span><span class="p">,</span> <span class="n">tsne_verbose</span><span class="p">,</span> <span class="n">k_means_cluster_number</span><span class="p">):</span>
    <span class="n">coordinates</span><span class="p">,</span> <span class="n">mz_values</span><span class="p">,</span> <span class="n">intensities</span> <span class="o">=</span> <span class="n">load_and_preprocess_imzml</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">structuring_element_size</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="p">],</span>
        <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="p">],</span>
        <span class="s1">&#39;mz_values&#39;</span><span class="p">:</span> <span class="n">mz_values</span><span class="p">,</span>
        <span class="s1">&#39;intensities&#39;</span><span class="p">:</span> <span class="n">intensities</span><span class="p">})</span>
    <span class="n">intensity_matrix</span><span class="p">,</span> <span class="n">all_mz_values</span> <span class="o">=</span> <span class="n">create_intensity_matrix</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">mz_values</span><span class="p">,</span> <span class="n">intensities</span><span class="p">)</span>
    <span class="n">intensity_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">intensity_matrix</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">all_mz_values</span><span class="p">)</span> <span class="c1"># Convert the intensity matrix to a DataFrame</span>
    <span class="n">df_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]],</span> <span class="n">intensity_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Combine coordinates with the intensity data   </span>
    <span class="n">perplexities</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
    <span class="n">learning_rates</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">350</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>
    <span class="n">n_iters</span> <span class="o">=</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">750</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">]</span>
    <span class="n">best_silhouette</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">best_tsne_result</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">results_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Initialize a list to store results</span>
    <span class="c1"># Grid search over t-SNE parameters</span>
    <span class="k">for</span> <span class="n">perplexity</span> <span class="ow">in</span> <span class="n">perplexities</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">learning_rate</span> <span class="ow">in</span> <span class="n">learning_rates</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n_iter</span> <span class="ow">in</span> <span class="n">n_iters</span><span class="p">:</span>
                <span class="n">pca_result</span><span class="p">,</span> <span class="n">tsne_result</span> <span class="o">=</span> <span class="n">apply_dimensionality_reduction</span><span class="p">(</span><span class="n">intensity_matrix</span><span class="p">,</span> <span class="n">pca_components</span><span class="p">,</span> <span class="n">tsne_components</span><span class="p">,</span> <span class="n">perplexity</span><span class="p">,</span><span class="n">n_iter</span><span class="p">,</span><span class="n">learning_rate</span><span class="p">)</span>
                <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">k_means_cluster_number</span><span class="p">)</span> <span class="c1"># Cluster using K-means</span>
                <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">tsne_result</span><span class="p">)</span>
                <span class="n">silhouette_avg</span> <span class="o">=</span> <span class="n">silhouette_score</span><span class="p">(</span><span class="n">tsne_result</span><span class="p">,</span> <span class="n">cluster_labels</span><span class="p">)</span> <span class="c1"># Calculate Silhouette score</span>
                <span class="c1"># print(f&quot;Current Silhouette Score: {silhouette_avg}&quot;)</span>
                <span class="c1"># print(f&quot;Best Silhouette Score: {best_silhouette}&quot;)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="c1"># Create t-SNE scatterplot</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">tsne_result</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">tsne_result</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">hue</span><span class="o">=</span><span class="n">cluster_labels</span><span class="p">,</span>
                    <span class="n">palette</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;tab10&quot;</span><span class="p">),</span>
                    <span class="n">legend</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span>
                <span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;t-SNE with Perplexity=</span><span class="si">{</span><span class="n">perplexity</span><span class="si">}</span><span class="s1">, LR=</span><span class="si">{</span><span class="n">learning_rate</span><span class="si">}</span><span class="s1">, Iter=</span><span class="si">{</span><span class="n">n_iter</span><span class="si">}</span><span class="s1">, Silhouette=</span><span class="si">{</span><span class="n">silhouette_avg</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">tsne_plot_outpath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_directory</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="s2">_tSNE_p</span><span class="si">{</span><span class="n">perplexity</span><span class="si">}</span><span class="s2">_lr</span><span class="si">{</span><span class="n">learning_rate</span><span class="si">}</span><span class="s2">_iter</span><span class="si">{</span><span class="n">n_iter</span><span class="si">}</span><span class="s2">_sil</span><span class="si">{</span><span class="n">silhouette_avg</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">.png&quot;</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">tsne_plot_outpath</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
                <span class="n">cluster_image_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span> <span class="c1"># Create the full cluster image</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>
                    <span class="n">cluster_image_full</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">([</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_means_cluster_number</span><span class="p">)])</span>
                <span class="n">im_full</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cluster_image_full</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cluster Image with Perplexity=</span><span class="si">{</span><span class="n">perplexity</span><span class="si">}</span><span class="s1">, LR=</span><span class="si">{</span><span class="n">learning_rate</span><span class="si">}</span><span class="s1">, Iter=</span><span class="si">{</span><span class="n">n_iter</span><span class="si">}</span><span class="s1">, Silhouette=</span><span class="si">{</span><span class="n">silhouette_avg</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">cluster_plot_outpath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_directory</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="s2">_ClusterImage_p</span><span class="si">{</span><span class="n">perplexity</span><span class="si">}</span><span class="s2">_lr</span><span class="si">{</span><span class="n">learning_rate</span><span class="si">}</span><span class="s2">_iter</span><span class="si">{</span><span class="n">n_iter</span><span class="si">}</span><span class="s2">_sil</span><span class="si">{</span><span class="n">silhouette_avg</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">.png&quot;</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">cluster_plot_outpath</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">results_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;Perplexity&#39;</span><span class="p">:</span> <span class="n">perplexity</span><span class="p">,</span>
                    <span class="s1">&#39;Learning Rate&#39;</span><span class="p">:</span> <span class="n">learning_rate</span><span class="p">,</span>
                    <span class="s1">&#39;Iterations&#39;</span><span class="p">:</span> <span class="n">n_iter</span><span class="p">,</span>
                    <span class="s1">&#39;Silhouette Score&#39;</span><span class="p">:</span> <span class="n">silhouette_avg</span><span class="p">,</span>
                    <span class="s1">&#39;Clusters&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cluster_labels</span><span class="p">))})</span> <span class="c1"># Append the results to the list</span>
                <span class="k">if</span> <span class="n">silhouette_avg</span> <span class="o">&gt;</span> <span class="n">best_silhouette</span><span class="p">:</span> <span class="c1"># Check if this is the best score so far</span>
                    <span class="n">best_silhouette</span> <span class="o">=</span> <span class="n">silhouette_avg</span>
                    <span class="n">best_tsne_result</span> <span class="o">=</span> <span class="n">tsne_result</span>
    <span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results_list</span><span class="p">)</span> <span class="c1"># Create a DataFrame from the results list</span>
    <span class="n">results_csv_outpath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_directory</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">sample_name</span><span class="si">}</span><span class="s2">_tSNE_Results_pt2.csv&quot;</span>     <span class="c1"># Save the results DataFrame as a CSV</span>
    <span class="n">results_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">results_csv_outpath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">tsne_result</span> <span class="o">=</span> <span class="n">best_tsne_result</span> <span class="c1"># Use the best t-SNE result</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tsne-one&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsne_result</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tsne-two&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsne_result</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">k_means_cluster_number</span><span class="p">)</span> <span class="c1"># Cluster using K-means with the best t-SNE result</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">tsne_result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">tsne_result</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">MSIght</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Modules</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Li Lab (UW-Madison).
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>